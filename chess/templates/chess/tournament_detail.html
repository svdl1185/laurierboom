<!-- templates/chess/tournament_detail.html - With improved styling and clear labels -->
{% extends 'chess/base.html' %}

{% block title %}{{ tournament.name }} - De Laurierboom Chess{% endblock %}

{% block extra_css %}
<style>
    /* Base styles */
    body {
        background-color: #1a2721;
        color: #ffffff;
        font-family: 'Roboto', sans-serif;
    }
    
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }
    
    /* Tournament header styles */
    .tournament-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #ffffff;
        margin-top: 2rem;
        margin-bottom: 0.5rem;
        font-family: 'Playfair Display', serif;
    }
    
    .live-indicator {
        display: inline-block;
        position: relative;
        color: #ffffff;
        font-size: 1.25rem;
        margin-left: 0.5rem;
        vertical-align: middle;
    }
    
    .live-indicator::before {
        content: '';
        display: inline-block;
        width: 12px;
        height: 12px;
        background-color: #ff0000;
        border-radius: 50%;
        margin-right: 0.2rem;
    }
    
    .tournament-location {
        font-size: 1.2rem;
        margin-top: 0;
        margin-bottom: 2rem;
        color: #ffffff;
    }
    
    /* Panel styles */
    .tournament-panel {
        background-color: #19e893;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tournament-panel-title {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 1.5rem;
        color: #000000;
        font-family: 'Playfair Display', serif;
    }
    
    /* Info container styles */
    .info-container {
        width: 100%;
        background-color: #ffffff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        color: #000000;
    }
    
    .info-item {
        color: #000000;
        margin-bottom: 1.25rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .info-item:last-child {
        margin-bottom: 0;
    }
    
    .info-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        color: rgba(0, 0, 0, 0.6);
        letter-spacing: 0.5px;
    }
    
    .info-value {
        font-size: 1.25rem;
        font-weight: 500;
    }
    
    .description-container {
        width: 100%;
        background-color: #ffffff;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0 1.5rem 0;
    }
    
    .description-text {
        margin: 0;
        color: #000000;
        text-align: center;
        font-size: 1rem;
        line-height: 1.5;
    }
    
    /* Table styles */
    .tournament-table {
        width: 100%;
        background-color: #ffffff;
        border-radius: 10px;
        overflow: hidden;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .tournament-table tr {
        height: 4rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .tournament-table tr:last-child {
        border-bottom: none;
    }
    
    .tournament-table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        font-size: 1rem;
    }
    
    /* Standings Table Container */
    .standings-table-container {
        width: 100%;
        background-color: #ffffff;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .standings-table {
        width: 100%;
        margin-bottom: 0;
    }
    
    .standings-table thead th {
        padding: 1rem;
        background-color: rgba(0, 0, 0, 0.05);
        font-weight: 600;
        color: #000000;
        border-bottom: 1px solid #f0f0f0;
        font-size: 1rem;
    }
    
    .standings-table tr {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .standings-table tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
        transform: translateX(3px);
    }
    
    .standings-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
        color: #000000;
        font-size: 1rem;
    }
    
    .standings-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Rank badge styling */
    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        border-radius: 50%;
        font-weight: 700;
        color: #000000;
        background-color: #f8f9fa;
        font-size: 0.9rem;
    }
    
    .rank-1 {
        background-color: #FFD700 !important;
        color: #5F4C0B !important;
    }
    
    .rank-2 {
        background-color: #C0C0C0 !important;
        color: #333333 !important;
    }
    
    .rank-3 {
        background-color: #CD7F32 !important;
        color: #ffffff !important;
    }
    
    .rank-tied {
        background-color: #87CEEB !important;
        color: #333333 !important;
    }
    
    .rank-position {
        display: flex;
        align-items: center;
    }
    
    .rank-change {
        font-size: 1rem;
        margin-left: 0.5rem; 
        display: inline-block;
        width: 20px;
        text-align: center;
    }
    
    .rank-up {
        color: #19e893;
    }
    
    .rank-down {
        color: #ff0000;
    }
    
    /* Player and score styling */
    .player-name {
        font-weight: 500;
        color: #000000;
        font-size: 1rem;
    }
    
    .player-score {
        font-weight: 600;
        text-align: right;
        font-size: 1rem;
    }
    
    /* Pairings styles */
    .pairings-board {
        font-size: 1.25rem;
        font-weight: bold;
        text-align: center;
        color: #000000;
    }
    
    .pairings-player {
        font-size: 1.25rem;
        font-weight: bold;
        color: #000000;
    }
    
    .pairings-result {
        font-size: 1.25rem;
        font-weight: bold;
        text-align: center;
        color: #000000;
        position: relative;
        padding-left: 0;
        padding-right: 0;
    }
    
    .pairings-result span {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        text-align: center;
    }
    
    /* Participant row styling */
    .participant-row {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
    }
    
    .participant-row:last-child {
        border-bottom: none;
    }
    
    .participant-row:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .participant-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
        border-radius: 50%;
        font-weight: 700;
        color: #000000;
        background-color: #f8f9fa;
        margin-right: 1rem;
        font-size: 0.9rem;
    }
    
    .participant-name {
        font-size: 1.1rem;
        font-weight: 500;
        flex-grow: 1;
        color: #000000;
    }
    
    .participant-rating {
        font-weight: 600;
        margin-right: 1rem;
        color: #000000;
        font-size: 1rem;
    }
    
    /* Button styles */
    .admin-buttons {
        display: flex;
        margin-top: 1.5rem;
    }
    
    .edit-btn {
        display: flex;
        align-items: center;
        background-color: #ffffff;
        color: #000000;
        border: none;
        border-radius: 5px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        margin-right: 0.75rem;
        text-decoration: none;
        font-size: 1rem;
    }
    
    .edit-btn:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #000000;
    }
    
    .start-btn {
        display: flex;
        align-items: center;
        background-color: #f7b945;
        color: #000000;
        border: none;
        border-radius: 5px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-decoration: none;
        font-size: 1rem;
    }
    
    .start-btn:hover {
        background-color: #f0ad2b;
        text-decoration: none;
        color: #000000;
    }
    
    .btn-icon {
        margin-right: 0.5rem;
    }
    
    /* Registration button */
    .registration-btn {
        background-color: #19e893;
        color: #000000;
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
        display: inline-block;
    }
    
    .registration-btn:hover {
        background-color: #15cb7f;
        text-decoration: none;
        color: #000000;
    }
    
    /* Match results styling */
    .match-result-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .result-win {
        background-color: #d4edda;
        color: #155724;
    }
    
    .result-loss {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .result-draw {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .result-pending {
        background-color: #e2e3e5;
        color: #383d41;
    }
    
    /* Winner section styling in completed tournament */
    .winner-section {
        text-align: center;
        padding: 2rem 1rem;
    }
    
    .trophy-icon {
        font-size: 3rem;
        color: #f7b945;
        margin-bottom: 0.5rem;
    }
    
    .winner-label {
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
        color: #000;
    }
    
    .winner-name {
        margin-bottom: 0.5rem;
        font-size: 1.75rem;
        color: #000;
        font-weight: 600;
    }
    
    .winner-score {
        color: #666;
        font-size: 1.1rem;
    }
    
    /* Accordion styles for rounds */
    .rounds-accordion {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        background-color: #ffffff;
    }
    
    .rounds-accordion .accordion-item {
        border: none;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .rounds-accordion .accordion-item:last-child {
        border-bottom: none;
    }
    
    .rounds-accordion .accordion-button {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: #000000;
        background-color: #ffffff;
    }
    
    .rounds-accordion .accordion-button:not(.collapsed) {
        color: #000000;
        background-color: #f8f9fa;
        box-shadow: none;
    }
    
    .rounds-accordion .accordion-button:focus {
        box-shadow: none;
        border-color: #f0f0f0;
    }

    .admin-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px; /* Consistent spacing between buttons */
        margin-top: 1.5rem;
        justify-content: center; /* Center all buttons */
    }
    
    .edit-btn, .start-btn, .delete-btn {
        display: flex;
        align-items: center;
        border: none;
        border-radius: 5px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .edit-btn {
        background-color: #ffffff;
        color: #000000;
    }
    
    .start-btn {
        background-color: #f7b945;
        color: #000000;
    }
    
    .delete-btn {
        background-color: #dc3545;
        color: #ffffff;
    }
    
    .edit-btn:hover, .start-btn:hover, .delete-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        text-decoration: none;
    }
    
    .btn-icon {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}

<!-- REGISTRATION PHASE (Not Started) -->
{% if not tournament.has_started and not tournament.is_completed %}
    <div class="page-container">
        <h1 class="tournament-title">{{ tournament.name }}</h1>
        <p class="tournament-location">{{ tournament.location }}</p>

        <div class="row">
            <!-- Left Column: Tournament Information -->
            <div class="col-md-5">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Tournament Info</h2>
                    
                    <div class="info-container">
                        <!-- Date -->
                        <div class="info-item">
                            {{ tournament.date }}
                        </div>
                        
                        <!-- Time -->
                        {% if tournament.start_time %}
                        <div class="info-item">
                            {{ tournament.start_time }}
                        </div>
                        {% endif %}
                        
                        <!-- Time Control -->
                        <div class="info-item">
                            <div class="info-label">Time Control</div>
                            <div class="info-value">
                                {% if tournament.time_control == 'bullet' %}
                                    Bullet
                                {% elif tournament.time_control == 'blitz' %}
                                    Blitz
                                {% elif tournament.time_control == 'rapid' %}
                                    Rapid
                                {% elif tournament.time_control == 'classical' %}
                                    Classical
                                {% else %}
                                    TBD
                                {% endif %}
                            </div>
                        </div>

                        <!-- Format -->
                        <div class="info-item">
                            <div class="info-label">Format</div>
                            <div class="info-value">
                                {% if tournament.tournament_type == 'round_robin' %}
                                    Round Robin
                                {% elif tournament.tournament_type == 'double_round_robin' %}
                                    Double Round Robin
                                {% elif tournament.tournament_type == 'swiss' %}
                                    Swiss
                                {% else %}
                                    TBD
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Total Rounds -->
                        <div class="info-item">
                            <div class="info-label">Rounds</div>
                            <div class="info-value">
                                {% if tournament.is_swiss_type %}
                                    {{ tournament.num_rounds }}
                                {% elif tournament.tournament_type == 'round_robin' %}
                                    {% with participant_count=tournament.participants.count %}
                                        {% if participant_count|divisibleby:2 %}
                                            {{ participant_count|add:"-1" }}
                                        {% else %}
                                            {{ participant_count }}
                                        {% endif %}
                                    {% endwith %}
                                {% elif tournament.tournament_type == 'double_round_robin' %}
                                    {% with participant_count=tournament.participants.count %}
                                        {% if participant_count|divisibleby:2 %}
                                            {{ participant_count|add:"-1" }}√ó2
                                        {% else %}
                                            {{ participant_count }}√ó2
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    TBD
                                {% endif %}
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">Players</div>
                            <div class="info-value">
                                {{ tournament.participants.count }}/{{ tournament.max_participants }}
                            </div>
                        </div>
                    </div>
                    
                    {% if tournament.description %}
                    <div class="description-container">
                        <p class="description-text">{{ tournament.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if user.is_staff %}
                        <div class="admin-buttons">
                            <a href="{% url 'tournament_update' tournament.id %}" class="edit-btn">
                                <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit Tournament
                            </a>
                            <a href="{% url 'tournament_start' tournament.id %}" class="start-btn">
                                <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                Start Tournament
                            </a>
                            <a href="{% url 'tournament_delete' tournament.id %}" class="delete-btn" style="background-color: #dc3545; color: white; display: flex; align-items: center; border: none; border-radius: 5px; padding: 0.75rem 1.5rem; font-weight: 600; text-decoration: none; margin-left: 0.75rem;">
                                <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                                Delete Tournament
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column: Participants -->
            <div class="col-md-7">
                <div class="tournament-panel" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="tournament-panel-title">Participants</h2>
                        {% if user.is_staff and not tournament.is_full %}
                            <a href="#" class="btn btn-success add-player-btn" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                                <i class="fas fa-plus me-2"></i>Add Player
                            </a>
                        {% endif %}
                    </div>
                    
                    <div class="standings-table-container">
                        <table class="table standings-table mb-0">
                            <thead style="background-color: #f8f9fa; border-bottom: 1px solid #eee;">
                                <tr>
                                    <th class="ps-3" style="width: 70px; color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">#</th>
                                    <th style="color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">Player</th>
                                    <th class="text-end pe-3" style="color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in tournament.participants.all %}
                                    <tr onclick="window.location.href='{% url 'profile_detail' player.id %}'">
                                        <td class="ps-3" style="width: 70px;">
                                            <div class="rank-badge">{{ forloop.counter }}</div>
                                        </td>
                                        <td>
                                            <span class="player-name">{{ player.get_full_name|default:player.username }}</span>
                                        </td>
                                        <td class="text-end pe-3">
                                            {% if tournament.time_control == 'bullet' %}
                                                {{ player.bullet_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'blitz' %}
                                                {{ player.blitz_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'rapid' %}
                                                {{ player.rapid_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'classical' %}
                                                {{ player.classical_elo|floatformat:0 }}
                                            {% else %}
                                                {{ player.elo|floatformat:0 }}
                                            {% endif %}
                                        </td>
                                        {% if user.is_staff %}
                                            <td style="width: 50px;">
                                                <a href="{% url 'remove_player_from_tournament' tournament.id player.id %}"
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('Are you sure you want to remove this player?');">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="{% if user.is_staff %}4{% else %}3{% endif %}" class="text-center py-4">
                                            No participants yet
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <br>
                    {% if user.is_authenticated and user not in tournament.participants.all and not tournament.is_full and not user.is_staff%}
                        <form method="post" action="{% url 'tournament_register' tournament.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-user-plus me-2"></i>Register for Tournament
                            </button>
                        </form>
                    {% elif user.is_authenticated and user in tournament.participants.all %}
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i> You are registered for this tournament
                            </div>
                            <form method="post" action="{% url 'tournament_unregister' tournament.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to unregister from this tournament?');">
                                    <i class="fas fa-user-minus me-1"></i>Unregister
                                </button>
                            </form>
                        </div>
                    {% elif user.is_authenticated and tournament.is_full %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i> Tournament is full
                        </div>
                    {% elif not user.is_authenticated %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> <a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to register for this tournament
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    {% if user.is_staff %}
    <div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlayerModalLabel">Add Player to Tournament</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-player-form" method="post" action="{% url 'add_player_to_tournament' tournament.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="player-select" class="form-label">Select Player</label>
                            <select name="player" id="player-select" class="form-select" required>
                                <option value="">-- Select Player --</option>
                                {% for player in available_players %}
                                    <option value="{{ player.id }}">{{ player.get_full_name|default:player.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Player</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

<!-- ONGOING PHASE (Tournament Has Started) -->
{% elif tournament.has_started and not tournament.is_completed %}
    <div class="page-container">
        <h1 class="tournament-title">{{ tournament.name }} <span class="live-indicator">live</span></h1>
        <p class="tournament-location">{{ tournament.location }}</p>
        <div class="row">
            <!-- Left Column: Standings -->
            <div class="col-md-7">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Standings</h2>
                    
                    <div class="standings-table-container">
                        <!-- Keep the existing table structure exactly as it is -->
                        <table class="table standings-table mb-0" id="standings-table">
                            <thead style="background-color: #f8f9fa; border-bottom: 1px solid #eee;">
                                <tr>
                                    <th class="ps-3" style="width: 70px; color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">Rank</th>
                                    <th style="color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">Player</th>
                                    <th class="text-end pe-3" style="color: #000000 !important; font-weight: 600; padding: 0.75rem 1rem;">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for standing in standings %}
                                    {% if not standing.player.is_staff and not standing.player.is_superuser %}
                                        <tr onclick="window.location.href='{% url 'profile_detail' standing.player.id %}'">
                                            <td class="ps-3" style="width: 70px;">
                                                <div class="rank-position">
                                                    <div class="rank-badge {% if standing.rank <= 3 %}rank-{{ standing.rank }}{% endif %}">
                                                        {{ standing.rank|default:1 }}
                                                    </div>
                                                    
                                                    <!-- Triangle rank change indicator -->
                                                    {% if standing.previous_rank and standing.previous_rank != standing.rank %}
                                                        {% if standing.previous_rank > standing.rank %}
                                                            <span class="rank-change rank-up ml-2">‚ñ≤</span>
                                                        {% elif standing.previous_rank < standing.rank %}
                                                            <span class="rank-change rank-down ml-2">‚ñº</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="rank-change ml-2">-</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="player-name">{{ standing.player.get_full_name|default:standing.player.username }}</span>
                                            </td>
                                            <td class="text-end pe-3">
                                                <span class="player-score">{{ standing.score }}</span>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center py-4">No standings yet</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Pairings -->
            <div class="col-md-5">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Round {{ current_round.number }}</h2>
                    <table class="tournament-table" style="width: 100%;">
                        <thead style="background-color: #f8f9fa; border-bottom: 1px solid #eee;">
                            <tr>
                                <th style="width: 10%; text-align: left; padding: 0.75rem 1rem; color: #000000 !important; font-weight: 600;">Board</th>
                                <th style="width: 25%; text-align: left; padding: 0.75rem 1rem; color: #000000 !important; font-weight: 600;">White</th>
                                <th style="width: 30%; text-align: center; padding: 0.75rem 1rem; color: #000000 !important; font-weight: 600;">Score</th>
                                <th style="width: 25%; text-align: left; padding: 0.75rem 1rem; color: #000000 !important; font-weight: 600;">Black</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in current_matches %}
                                <tr>
                                    <td style="width: 10%; text-align: left; color: #000000 !important; font-weight: bold;">{{ forloop.counter }}</td>
                                    <td style="width: 25%; text-align: left; color: #000000 !important; font-weight: bold;">
                                        {{ match.white_player.get_full_name|default:match.white_player.username }}
                                        <div style="font-size: 0.875rem; color: #666;">
                                            {% if tournament.time_control == 'bullet' %}
                                                {{ match.white_player.bullet_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'blitz' %}
                                                {{ match.white_player.blitz_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'rapid' %}
                                                {{ match.white_player.rapid_elo|floatformat:0 }}
                                            {% elif tournament.time_control == 'classical' %}
                                                {{ match.white_player.classical_elo|floatformat:0 }}
                                            {% else %}
                                                {{ match.white_player.elo|floatformat:0 }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="width: 30%; text-align: center; color: #000000 !important; font-weight: bold;">
                                        {% if match.black_player %}
                                            {% if match.result == 'white_win' %}
                                                1 - 0
                                            {% elif match.result == 'black_win' %}
                                                0 - 1
                                            {% elif match.result == 'draw' %}
                                                ¬Ω - ¬Ω
                                            {% else %}
                                                ... - ...
                                            {% endif %}
                                        {% elif match.result == 'bye' %}
                                            <!-- Bye display -->
                                            <span style="font-size: 1.5em;">üç∫</span><br>
                                            <small style="color: #198754; font-weight: 500;">Bye (1 point)</small>
                                        {% endif %}
                                    </td>
                                    <td style="width: 25%; text-align: left; color: #000000 !important; font-weight: bold;">
                                        {% if match.black_player %}
                                            {{ match.black_player.get_full_name|default:match.black_player.username }}
                                            <div style="font-size: 0.875rem; color: #666;">
                                                {% if tournament.time_control == 'bullet' %}
                                                    {{ match.black_player.bullet_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'blitz' %}
                                                    {{ match.black_player.blitz_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'rapid' %}
                                                    {{ match.black_player.rapid_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'classical' %}
                                                    {{ match.black_player.classical_elo|floatformat:0 }}
                                                {% else %}
                                                    {{ match.black_player.elo|floatformat:0 }}
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span style="color: #666; font-style: italic;">Bye</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 1rem; color: #000000 !important;">
                                        No matches in current round
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modified section for tournament rounds in tournament_detail.html -->
        {% if user.is_staff and not tournament.is_completed %}
            <!-- All Rounds Accordion Section for Previous Rounds -->
            <div class="row mt-4">
                <div class="col-12">
                    <h3>Tournament Rounds</h3>
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="accordion" id="roundsAccordion">
                                {% for round_obj in rounds %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ round_obj.number }}">
                                            <button class="accordion-button {% if round_obj.number != current_round.number %}collapsed{% endif %}" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ round_obj.number }}" 
                                                    aria-expanded="{% if round_obj.number == current_round.number %}true{% else %}false{% endif %}" 
                                                    aria-controls="collapse{{ round_obj.number }}">
                                                Round {{ round_obj.number }} 
                                                {% if round_obj.is_completed %}
                                                    <span class="badge bg-success ms-2">Completed</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark ms-2">In Progress</span>
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="collapse{{ round_obj.number }}" 
                                            class="accordion-collapse collapse {% if round_obj.number == current_round.number %}show{% endif %}" 
                                            aria-labelledby="heading{{ round_obj.number }}" 
                                            data-bs-parent="#roundsAccordion">
                                            <div class="accordion-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover" id="round-table-{{ round_obj.number }}">
                                                        <thead>
                                                            <tr>
                                                                <!-- Board number column will be added by JS -->
                                                                <th>White</th>
                                                                <th>Result</th>
                                                                <th>Black</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for match in round_obj.matches.all %}
                                                                <tr data-match-id="{{ match.id }}">
                                                                    <td>{{ match.white_player.get_full_name|default:match.white_player.username }}</td>
                                                                    <td>
                                                                        {% if user.is_staff %}
                                                                            <form method="post" action="{% url 'inline_match_result' match.id %}" class="d-inline match-result-form">
                                                                                {% csrf_token %}
                                                                                <select name="result" class="form-select form-select-sm result-select" 
                                                                                        id="result-select-{{ match.id }}" 
                                                                                        data-match-id="{{ match.id }}">
                                                                                    <option value="pending" {% if match.result == 'pending' %}selected{% endif %}>Pending</option>
                                                                                    <option value="white_win" {% if match.result == 'white_win' %}selected{% endif %}>1-0 (White wins)</option>
                                                                                    <option value="black_win" {% if match.result == 'black_win' %}selected{% endif %}>0-1 (Black wins)</option>
                                                                                    <option value="draw" {% if match.result == 'draw' %}selected{% endif %}>¬Ω-¬Ω (Draw)</option>
                                                                                    <option value="white_forfeit" {% if match.result == 'white_forfeit' %}selected{% endif %}>+/- (White forfeit)</option>
                                                                                    <option value="black_forfeit" {% if match.result == 'black_forfeit' %}selected{% endif %}>-/+ (Black forfeit)</option>
                                                                                    {% if not match.black_player %}
                                                                                    <option value="bye" {% if match.result == 'bye' %}selected{% endif %}>Bye</option>
                                                                                    {% endif %}
                                                                                </select>
                                                                            </form>
                                                                        {% else %}
                                                                            {% if match.black_player %}
                                                                                {% if match.result == 'white_win' %}
                                                                                    <span class="badge bg-success">1-0</span>
                                                                                {% elif match.result == 'black_win' %}
                                                                                    <span class="badge bg-success">0-1</span>
                                                                                {% elif match.result == 'draw' %}
                                                                                    <span class="badge bg-warning text-dark">¬Ω-¬Ω</span>
                                                                                {% elif match.result == 'white_forfeit' %}
                                                                                    <span class="badge bg-danger">+/- (White forfeit)</span>
                                                                                {% elif match.result == 'black_forfeit' %}
                                                                                    <span class="badge bg-danger">-/+ (Black forfeit)</span>
                                                                                {% else %}
                                                                                    <span class="badge bg-secondary">Pending</span>
                                                                                {% endif %}
                                                                            {% elif match.result == 'bye' %}
                                                                                <span style="font-size: 1.2em;">üç∫</span>
                                                                                <span class="badge bg-success">+1</span>
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if match.black_player %}
                                                                            <a href="{% url 'profile_detail' match.black_player.id %}">
                                                                                {{ match.black_player.get_full_name|default:match.black_player.username }}
                                                                            </a>
                                                                        {% else %}
                                                                            <span style="color: #666; font-style: italic;">Bye</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                            {% empty %}
                                                                <tr class="empty-row">
                                                                    <td colspan="4" class="text-center">
                                                                        No matches found for this round.
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <!-- Batch update button will be added here by JS -->
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Admin Controls Section Update (with Complete Current Round button) -->
        {% if user.is_staff %}
            <div class="admin-controls mt-4">
                <h3>Admin Controls</h3>
                <div class="card">
                    <div class="card-body">
                        {% if current_round and not all_rounds_completed %}
                            <form method="post" action="{% url 'complete_round' tournament.id current_round.id %}" class="d-inline mb-3" 
                                onsubmit="return confirm('Are all matches complete? This will generate the next round.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-check-circle me-1"></i> Complete Current Round
                                </button>
                            </form>
                        {% endif %}
                
                        {% if user.is_staff and can_end_tournament %}
                            <form method="post" action="{% url 'complete_tournament' tournament.id %}" class="d-inline ms-2" 
                                onsubmit="return confirm('Are you sure you want to complete this tournament? This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-flag-checkered me-2"></i>End Tournament
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>


    <!-- COMPLETED PHASE -->
{% elif tournament.is_completed %}
    <div class="page-container">
        <h1 class="tournament-title">{{ tournament.name }}</h1>
        <p class="tournament-location">{{ tournament.location }}</p>
        
        <div class="row">
            <!-- Left Column: Tournament Summary with Winner -->
            <div class="col-md-5">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Tournament Summary</h2>
                    
                    <!-- Winner highlight in white container -->
                    <div class="info-container">
                        {% for standing in standings %}
                            {% if standing.rank == 1 %}
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="margin-bottom: 1rem; font-size: 3rem; color: #f7b945;"><i class="fas fa-trophy"></i></div>
                                    <div style="margin-bottom: 0.5rem; font-weight: bold; font-size: 1.25rem;">Winner</div>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #000; margin-bottom: 0.5rem;">
                                        {{ standing.player.get_full_name|default:standing.player.username }}
                                    </div>
                                    <div style="color: #666;">{{ standing.score }} points</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Tournament Info in white container -->
                    <div class="info-container">
                        <!-- Date -->
                        <div class="info-item">
                            {{ tournament.date }}
                        </div>
                        
                        <!-- Time -->
                        {% if tournament.start_time %}
                        <div class="info-item">
                            {{ tournament.start_time }}
                        </div>
                        {% endif %}
                        
                        <!-- Format -->
                        <div class="info-item">
                            <div class="info-label">FORMAT</div>
                            <div class="info-value">
                                {% if tournament.tournament_type == 'round_robin' %}
                                    Round Robin
                                {% elif tournament.tournament_type == 'double_round_robin' %}
                                    Double Round Robin
                                {% elif tournament.tournament_type == 'swiss' %}
                                    Swiss
                                {% else %}
                                    TBD
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Total Rounds -->
                        <div class="info-item">
                            <div class="info-label">ROUNDS</div>
                            <div class="info-value">
                                {{ rounds|length }}
                            </div>
                        </div>
                    </div>
                    
                    {% if tournament.description %}
                    <div class="description-container">
                        <p class="description-text">{{ tournament.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column: Final Standings -->
            <div class="col-md-7">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Final Standings</h2>
                    
                    <div class="standings-table-container">
                        <table class="table standings-table mb-0">
                            <thead> 
                                <tr> 
                                    <th class="ps-3" style="width: 70px;">Rank</th> 
                                    <th>Player</th> 
                                    <th class="text-center" style="width: 100px;">Rating</th> 
                                    <th class="text-end pe-3" style="width: 70px;">Score</th> 
                                </tr> 
                            </thead>
                            <tbody>
                                {% for standing in standings %}
                                    {% if not standing.player.is_staff and not standing.player.is_superuser %}
                                        <tr onclick="window.location.href='{% url 'profile_detail' standing.player.id %}'" 
                                            {% if standing.rank == 1 %}style="background-color: rgba(255, 215, 0, 0.1);"{% endif %}>
                                            <td class="ps-3" style="width: 70px;">
                                                <div class="rank-badge {% if standing.rank <= 3 %}rank-{{ standing.rank }}{% endif %}">
                                                    {{ standing.rank }}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="player-name">{{ standing.player.get_full_name|default:standing.player.username }}</span>
                                            </td>
                                            <td style="text-align: center; width: 100px; font-weight: normal;">
                                                {% if tournament.time_control == 'bullet' %}
                                                    {{ standing.player.bullet_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'blitz' %}
                                                    {{ standing.player.blitz_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'rapid' %}
                                                    {{ standing.player.rapid_elo|floatformat:0 }}
                                                {% elif tournament.time_control == 'classical' %}
                                                    {{ standing.player.classical_elo|floatformat:0 }}
                                                {% else %}
                                                    {{ standing.player.elo|floatformat:0 }}
                                                {% endif %}
                                            </td>
                                            <td class="text-end pe-3" style="width: 70px;">
                                                <span class="player-score">{{ standing.score }}</span>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4">No standings available</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Rounds Panel - Simplified -->
        <div class="row">
            <div class="col-12">
                <div class="tournament-panel">
                    <h2 class="tournament-panel-title">Rounds</h2>
                    
                    <div class="info-container" style="padding: 0;">
                        <!-- Accordion for rounds -->
                        <div class="accordion w-100" id="completedRoundsAccordion">
                            {% for round_obj in rounds %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ round_obj.number }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#collapse{{ round_obj.number }}">
                                            Round {{ round_obj.number }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ round_obj.number }}" class="accordion-collapse collapse" 
                                        aria-labelledby="heading{{ round_obj.number }}" data-bs-parent="#completedRoundsAccordion">
                                        <div class="accordion-body p-0">
                                            <table class="table mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="ps-3">White</th>
                                                        <th class="text-center">Result</th>
                                                        <th>Black</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for match in round_obj.matches.all %}
                                                        <tr>
                                                            <td class="ps-3">
                                                                <a href="{% url 'profile_detail' match.white_player.id %}">
                                                                    {{ match.white_player.get_full_name|default:match.white_player.username }}
                                                                </a>
                                                            </td>
                                                            <td class="text-center">
                                                                {% if match.black_player %}
                                                                    {% if match.result == 'white_win' %}
                                                                        <span class="match-result-badge result-win">1-0</span>
                                                                    {% elif match.result == 'black_win' %}
                                                                        <span class="match-result-badge result-win">0-1</span>
                                                                    {% elif match.result == 'draw' %}
                                                                        <span class="match-result-badge result-draw">¬Ω-¬Ω</span>
                                                                    {% elif match.result == 'white_forfeit' %}
                                                                        <span class="match-result-badge result-loss">+/- (White Forfeit)</span>
                                                                    {% elif match.result == 'black_forfeit' %}
                                                                        <span class="match-result-badge result-loss">-/+ (Black Forfeit)</span>
                                                                    {% else %}
                                                                        <span class="match-result-badge result-pending">Pending</span>
                                                                    {% endif %}
                                                                {% elif match.result == 'bye' %}
                                                                    <span style="font-size: 1.5em;">üç∫</span><br>
                                                                    <small class="match-result-badge result-win">Bye (+1)</small>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if match.black_player %}
                                                                    <a href="{% url 'profile_detail' match.black_player.id %}">
                                                                        {{ match.black_player.get_full_name|default:match.black_player.username }}
                                                                    </a>
                                                                {% else %}
                                                                    <span style="color: #666; font-style: italic;">Bye</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup two-column standings layout for large player counts
        function setupTwoColumnStandings() {
            const container = document.querySelector('.standings-table-container');
            const table = document.getElementById('standings-table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            // Check if the screen width is greater than 768px (typical breakpoint for tablets and desktops)
            if (rows.length > 10 && window.innerWidth > 768) {
                // Create a single container with white background to hold both tables
                const whiteContainer = document.createElement('div');
                whiteContainer.className = 'bg-white rounded-lg overflow-hidden';
                whiteContainer.style.display = 'flex'; // Use flexbox for the layout
                
                // Left table
                const leftTableDiv = document.createElement('div');
                leftTableDiv.style.flex = '1';
                leftTableDiv.style.borderRight = '4px solid #19e893'; // Green divider
                
                // Right table
                const rightTableDiv = document.createElement('div');
                rightTableDiv.style.flex = '1';
                
                // Create tables without borders that would stick out
                const leftTable = table.cloneNode(true);
                leftTable.id = 'left-standings-table';
                leftTable.style.marginBottom = '0';
                
                const rightTable = table.cloneNode(true);
                rightTable.id = 'right-standings-table';
                rightTable.style.marginBottom = '0';
                
                // Clear the tables and repopulate with split data
                const leftTbody = leftTable.querySelector('tbody');
                const rightTbody = rightTable.querySelector('tbody');
                
                // Clear existing rows
                leftTbody.innerHTML = '';
                rightTbody.innerHTML = '';
                
                // Calculate the midpoint
                const midpoint = Math.ceil(rows.length / 2);
                
                // Distribute rows
                rows.forEach((row, index) => {
                    if (index < midpoint) {
                        leftTbody.appendChild(row.cloneNode(true));
                    } else {
                        rightTbody.appendChild(row.cloneNode(true));
                    }
                });
                
                // Assemble everything
                leftTableDiv.appendChild(leftTable);
                rightTableDiv.appendChild(rightTable);
                
                whiteContainer.appendChild(leftTableDiv);
                whiteContainer.appendChild(rightTableDiv);
                
                // Clear the container and add our new layout
                container.innerHTML = '';
                container.appendChild(whiteContainer);
                
                // Re-attach click events
                container.querySelectorAll('tr').forEach(row => {
                    const url = row.getAttribute('onclick')?.toString().match(/'([^']+)'/)?.[1];
                    if (url) {
                        row.onclick = () => window.location.href = url;
                    }
                });
            }
        }
        
        // Run the function when the page loads
        setupTwoColumnStandings();

        // Auto-refresh for live tournament view (only for non-admin users)
        {% if tournament.has_started and not tournament.is_completed and not user.is_staff %}
        setInterval(function() {
            window.location.reload();
        }, 60000);  // Refresh every 60 seconds
        {% endif %}

        // Enhanced tournament admin controls (only for staff users)
        {% if user.is_staff %}
        // Store all changes before submitting
        const pendingChanges = new Map();
        
        // Add board numbers to match rows
        function addBoardNumbers() {
            const roundTables = document.querySelectorAll('.accordion-body .table');
            
            roundTables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr:not(.empty-row)');
                
                rows.forEach((row, index) => {
                    // Check if we already added a board number
                    if (!row.querySelector('.board-number')) {
                        // Create the board number cell
                        const boardNumberCell = document.createElement('td');
                        boardNumberCell.className = 'board-number text-center';
                        boardNumberCell.style.width = '50px';
                        boardNumberCell.style.fontWeight = 'bold';
                        boardNumberCell.textContent = (index + 1);
                        
                        // Insert it as the first cell
                        row.insertBefore(boardNumberCell, row.firstChild);
                        
                        // Add board number to header row if needed
                        const headerRow = table.querySelector('thead tr');
                        if (headerRow && !headerRow.querySelector('.board-header')) {
                            const boardHeader = document.createElement('th');
                            boardHeader.className = 'board-header text-center';
                            boardHeader.style.width = '50px';
                            boardHeader.textContent = '#';
                            headerRow.insertBefore(boardHeader, headerRow.firstChild);
                        }
                    }
                });
            });
        }
        
        // Create a single unified save button in the admin controls panel
        function createUnifiedSaveButton() {
            // Remove any existing save buttons
            document.querySelectorAll('.batch-update-container, #unified-save-button').forEach(el => {
                el.remove();
            });
            
            // Find the admin controls panel
            const adminPanel = document.querySelector('.admin-controls .card-body');
            if (!adminPanel) return;
            
            // Create the unified save button
            const saveButton = document.createElement('button');
            saveButton.id = 'unified-save-button';
            saveButton.type = 'button';
            saveButton.className = 'btn btn-primary me-2';
            saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save All Changes';
            saveButton.disabled = true;
            
            // Create status counter
            const statusCounter = document.createElement('span');
            statusCounter.className = 'ms-2 badge bg-secondary changes-counter';
            statusCounter.textContent = '0 changes';
            saveButton.appendChild(statusCounter);
            
            // Add event listener for saving changes
            saveButton.addEventListener('click', submitAllChanges);
            
            // Insert at the beginning of the admin controls
            const firstButton = adminPanel.querySelector('button, form');
            if (firstButton) {
                adminPanel.insertBefore(saveButton, firstButton);
            } else {
                adminPanel.appendChild(saveButton);
            }
        }
        
        // Update the highlight function to work with a unified button
        function highlightPendingChanges() {
            // Reset all highlights first
            document.querySelectorAll('tr.pending-change').forEach(row => {
                row.classList.remove('pending-change');
            });
            
            // Count total changes
            const totalChanges = pendingChanges.size;
            
            // Highlight rows with pending changes
            pendingChanges.forEach((newValue, selectId) => {
                const select = document.getElementById(selectId);
                if (select) {
                    const row = select.closest('tr');
                    if (row) {
                        row.classList.add('pending-change');
                    }
                }
            });
            
            // Update the unified save button
            const saveButton = document.getElementById('unified-save-button');
            if (saveButton) {
                saveButton.disabled = totalChanges === 0;
                
                const counter = saveButton.querySelector('.changes-counter');
                if (counter) {
                    counter.textContent = `${totalChanges} change${totalChanges !== 1 ? 's' : ''}`;
                    
                    // Update counter style based on number of changes
                    counter.className = 'ms-2 badge changes-counter';
                    counter.classList.add(totalChanges > 0 ? 'bg-warning text-dark' : 'bg-secondary');
                    
                    // Update the button color based on changes
                    if (totalChanges > 0) {
                        saveButton.classList.remove('btn-primary');
                        saveButton.classList.add('btn-success');
                    } else {
                        saveButton.classList.remove('btn-success');
                        saveButton.classList.add('btn-primary');
                    }
                }
            }
        }
        
        // Unified submit function for all changes
        async function submitAllChanges() {
            const totalChanges = pendingChanges.size;
            if (totalChanges === 0) return;
            
            // Get unified save button
            const saveButton = document.getElementById('unified-save-button');
            if (!saveButton) return;
            
            // Show loading state
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            // Process all pending changes
            const promises = [];
            
            pendingChanges.forEach((newValue, selectId) => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Get the form and create the request
                const form = select.closest('form');
                if (!form) return;
                
                const matchId = select.getAttribute('data-match-id');
                
                // Create a request promise
                const requestPromise = fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return { success: true, matchId };
                    } else {
                        return { success: false, matchId, error: data.error };
                    }
                })
                .catch(error => {
                    return { success: false, matchId, error: error.toString() };
                });
                
                promises.push(requestPromise);
            });
            
            // Wait for all requests to complete
            const results = await Promise.all(promises);
            
            // Check results and handle errors
            const failures = results.filter(result => !result.success);
            
            if (failures.length > 0) {
                // Show error message for failures
                alert(`Failed to update ${failures.length} matches. Please check the console for details.`);
                console.error('Failed updates:', failures);
                
                saveButton.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Some Updates Failed';
                
                // Only remove successful changes from pending changes
                const failedMatchIds = failures.map(f => f.matchId);
                
                pendingChanges.forEach((value, selectId) => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const matchId = select.getAttribute('data-match-id');
                    if (!failedMatchIds.includes(matchId)) {
                        pendingChanges.delete(selectId);
                    }
                });
            } else {
                // All successful - clear all pending changes
                pendingChanges.clear();
                
                // Show success message
                saveButton.innerHTML = '<i class="fas fa-check me-2"></i>Saved Successfully!';
            }
            
            // Update UI
            highlightPendingChanges();
            
            // Reload the page after successful save (give time to see the success message)
            if (failures.length === 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                saveButton.disabled = false;
            }
        }
        
        // Add CSS styles for the admin controls
        function addStyles() {
            // Check if styles already exist
            if (document.getElementById('tournament-admin-styles')) return;
            
            const styleElement = document.createElement('style');
            styleElement.id = 'tournament-admin-styles';
            styleElement.innerHTML = `
                tr.pending-change {
                    background-color: rgba(255, 193, 7, 0.15) !important;
                }
                
                tr.pending-change td {
                    font-weight: 600;
                }
                
                .result-select {
                    width: 100%;
                    min-width: 170px;
                }
                
                .board-number {
                    background-color: #f8f9fa;
                    border-right: 2px solid #dee2e6;
                }
                
                .board-header {
                    background-color: #f8f9fa;
                    border-right: 2px solid #dee2e6;
                }
                
                /* Green success button */
                .btn-success {
                    background-color: #48bb78;
                    border-color: #48bb78;
                }
                
                .btn-success:hover {
                    background-color: #38a169;
                    border-color: #38a169;
                }
                
                /* Fix any layout issues with admin controls */
                .admin-controls .card-body {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                    align-items: center;
                }
                
                #unified-save-button {
                    min-width: 180px;
                }
            `;
            document.head.appendChild(styleElement);
        }
        
        // Set up event listeners for all dropdowns
        function setupResultSelects() {
            const resultSelects = document.querySelectorAll('.result-select');
            
            resultSelects.forEach(select => {
                // Generate a unique ID for this select if it doesn't have one
                if (!select.id) {
                    select.id = `result-select-${select.getAttribute('data-match-id')}`;
                }
                
                // Store the original value
                select.setAttribute('data-original-value', select.value);
                
                // Remove any existing listeners to prevent duplicates
                const newSelect = select.cloneNode(true);
                if (select.parentNode) {
                    select.parentNode.replaceChild(newSelect, select);
                }
                
                // Add change event listener to the new select
                newSelect.addEventListener('change', function() {
                    const originalValue = this.getAttribute('data-original-value');
                    const selectId = this.id;
                    
                    if (this.value !== originalValue) {
                        // Add to pending changes
                        pendingChanges.set(selectId, this.value);
                    } else {
                        // Remove from pending changes if changed back to original
                        pendingChanges.delete(selectId);
                    }
                    
                    // Update UI to reflect pending changes
                    highlightPendingChanges();
                });
            });
        }
        
        // Initialize all components
        function init() {
            // Add styles
            addStyles();
            
            // Add board numbers
            addBoardNumbers();
            
            // Create the unified save button in admin panel
            createUnifiedSaveButton();
            
            // Setup result selects
            setupResultSelects();
            
            // Initial update of UI
            highlightPendingChanges();
        }
        
        // Initialize the admin controls
        init();
        {% endif %}
    });
</script>
{% endblock %}
{% endblock %}